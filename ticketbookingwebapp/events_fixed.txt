import React, { useState, useEffect } from 'react';
import {
    Card,
    Table,
    Button,
    Tag,
    Avatar,
    Input,
    Modal,
    Select,
    Space,
    Typography,
    Tooltip,
    Alert,
    message,
    Spin,
    Divider,
    Row,
    Col,
    Badge,
    Image,
    List
} from 'antd';
import {
    SearchOutlined,
    ReloadOutlined,
    EyeOutlined,
    CheckCircleOutlined,
    CloseCircleOutlined,
    EnvironmentOutlined,
    CalendarOutlined,
    StarFilled,
    StarOutlined,
    WarningOutlined,
    FilterOutlined,
    DeleteOutlined,
    StopOutlined,
    PlayCircleOutlined,
    CloudUploadOutlined,
    AppstoreOutlined
} from '@ant-design/icons';
import { api } from '@services/api';
import SeatMapTemplateView from '@features/organizer/components/SeatMapTemplateView';
import AdminLoadingScreen from '@features/admin/components/AdminLoadingScreen';

const { Text, Title, Paragraph } = Typography;

const AdminEventsManagement = () => {
    const [loading, setLoading] = useState(true);
    const [events, setEvents] = useState([]);
    const [selectedEvent, setSelectedEvent] = useState(null);
    const [showModal, setShowModal] = useState(false);
    const [actionLoading, setActionLoading] = useState(false);

    // Filter States
    const [filterStatus, setFilterStatus] = useState('ALL');
    const [filterFeatured, setFilterFeatured] = useState('ALL');
    const [searchQuery, setSearchQuery] = useState('');

    // Seat Map States
    const [venueTemplate, setVenueTemplate] = useState(null);
    const [eventSeats, setEventSeats] = useState([]);
    const [loadingMap, setLoadingMap] = useState(false);

    useEffect(() => {
        fetchEvents();
    }, []);

    useEffect(() => {
        if (selectedEvent && showModal) {
            fetchEventSeatMap();
        } else {
            setVenueTemplate(null);
            setEventSeats([]);
        }
    }, [selectedEvent, showModal]);

    const fetchEventSeatMap = async () => {
        try {
            setLoadingMap(true);
            const venueRes = await api.getVenueById(selectedEvent.venue_id);
            if (venueRes.success) {
                setVenueTemplate(venueRes.data.seat_map_template);
            }

            const seatsRes = await api.getAllEventSeats(selectedEvent.event_id);
            if (seatsRes.success) {
                const mappedSeats = seatsRes.data.map(s => ({
                    row_name: s.row_name,
                    seat_number: s.seat_number,
                    area: s.area_name,
                    ticket_type_id: s.ticket_type_id,
                    status: s.status
                }));
                setEventSeats(mappedSeats);
            }
        } catch (error) {
            console.error("Error fetching seat map info:", error);
            message.error("Không th? t?i so d? gh?");
        } finally {
            setLoadingMap(false);
        }
    };

    const fetchEvents = async () => {
        try {
            setLoading(true);
            const res = await api.getAllAdminEvents();
            if (res.success) setEvents(res.data);
        } catch (error) {
            console.error("Error fetching admin events:", error);
            message.error("L?i khi t?i danh sách s? ki?n");
        } finally {
            setLoading(false);
        }
    };

    const handleUpdateStatus = async (eventId, newStatus) => {
        try {
            setActionLoading(true);
            const data = { status: newStatus };
            const res = await api.adminUpdateEventStatus(eventId, data);
            if (res.success) {
                message.success(`C?p nh?t tr?ng thái thành công`);
                setShowModal(false);
                fetchEvents();
            }
        } catch (error) {
            message.error(error.message);
        } finally {
            setActionLoading(false);
        }
    };

    const toggleFeatured = async (event) => {
        const allowedStatuses = ['APPROVED', 'PUBLISHED', 'ONGOING'];
        if (!event.is_featured && !allowedStatuses.includes(event.status)) {
            message.warning("Ch? s? ki?n dă duy?t ho?c công khai m?i có th? dánh d?u n?i b?t");
            return;
        }

        try {
            const data = { is_featured: !event.is_featured };
            const res = await api.adminUpdateEventStatus(event.event_id, data);
            if (res.success) {
                message.success(event.is_featured ? "Đă b? dánh d?u n?i b?t" : "Đă dánh d?u s? ki?n n?i b?t");
                fetchEvents();
            }
        } catch (error) {
            message.error(error.message);
        }
    };

    const handleDeleteEvent = (eventId) => {
        Modal.confirm({
            title: 'Xác nh?n xóa vinh vi?n',
            icon: <WarningOutlined style={{ color: '#ff4d4f' }} />,
            content: 'B?n có ch?c ch?n mu?n XÓA VINH VI?N s? ki?n này không? Hành d?ng này không th? hoàn tác.',
            okText: 'Xác nh?n xóa',
            okType: 'danger',
            cancelText: 'H?y',
            onOk: async () => {
                try {
                    setActionLoading(true);
                    const res = await api.adminDeleteEvent(eventId);
                    if (res.success) {
                        message.success("Đă xóa s? ki?n thành công");
                        setShowModal(false);
                        fetchEvents();
                    }
                } catch (error) {
                    message.error(error.message);
                } finally {
                    setActionLoading(false);
                }
            }
        });
    };

    const getStatusConfig = (status) => {
        const configs = {
            'PUBLISHED': { color: 'success', label: 'Công khai', icon: <CloudUploadOutlined /> },
            'PENDING_APPROVAL': { color: 'warning', label: 'Ch? duy?t', icon: <SyncOutlined spin /> },
            'APPROVED': { color: 'cyan', label: 'Đă duy?t', icon: <CheckCircleOutlined /> },
            'REJECTED': { color: 'error', label: 'B? t? ch?i', icon: <CloseCircleOutlined /> },
            'DRAFT': { color: 'default', label: 'Nháp', icon: <ClockCircleOutlined /> },
            'CANCELLED': { color: 'error', label: 'Đă h?y', icon: <StopOutlined /> },
            'COMPLETED': { color: 'default', label: 'Hoàn thành', icon: <CheckCircleOutlined /> },
            'ONGOING': { color: 'processing', label: 'Đang di?n ra', icon: <PlayCircleOutlined /> },
            'PENDING_DELETION': { color: 'error', label: 'Ch? xóa', icon: <DeleteOutlined /> }
        };
        return configs[status] || { color: 'default', label: status, icon: null };
    };

    const filteredEvents = events.filter(event => {
        if (filterStatus !== 'ALL' && event.status !== filterStatus) return false;
        if (filterFeatured === 'FEATURED' && !event.is_featured) return false;
        if (filterFeatured === 'NOT_FEATURED' && event.is_featured) return false;
        if (searchQuery && !event.event_name.toLowerCase().includes(searchQuery.toLowerCase())) return false;
        return true;
    });

    const pendingCount = events.filter(e => e.status === 'PENDING_APPROVAL').length;

    const columns = [
        {
            title: '?NH B̀A',
            key: 'banner',
            render: (_, record) => (
                <Image
                    width={80}
                    height={45}
                    src={record.banner_image_url?.startsWith('http') ? record.banner_image_url : `http://127.0.0.1:5000${record.banner_image_url}`}
                    style={{ borderRadius: 4, objectFit: 'cover' }}
                />
            ),
        },
        {
            title: 'THÔNG TIN S? KI?N',
            key: 'info',
            render: (_, record) => (
                <Space direction="vertical" size={0}>
                    <Text strong style={{ fontSize: 14 }}>{record.event_name}</Text>
                    <Space size={8} style={{ fontSize: 12 }}>
                        <Text type="secondary"><EnvironmentOutlined /> {record.venue?.name || record.venue_name}</Text>
                        <Text type="secondary"><CalendarOutlined /> {new Date(record.start_datetime).toLocaleDateString('vi-VN')}</Text>
                    </Space>
                </Space>
            ),
        },
        {
            title: 'NHÀ T? CH?C',
            key: 'organizer',
            render: (_, record) => (
                <Space>
                    <Avatar size="small" style={{ backgroundColor: '#52c41a' }}>{record.organizer_name?.charAt(0)}</Avatar>
                    <Text style={{ fontSize: 13 }}>{record.organizer_name}</Text>
                </Space>
            ),
        },
        {
            title: 'TR?NG THÁI',
            key: 'status',
            align: 'center',
            render: (_, record) => {
                const config = getStatusConfig(record.status);
                return <Tag color={config.color} style={{ fontSize: '0.7rem' }}>{config.label.toUpperCase()}</Tag>;
            },
        },
        {
            title: 'N?I B?T',
            key: 'featured',
            align: 'center',
            render: (_, record) => (
                <Tooltip title={record.is_featured ? "B? n?i b?t" : "Đánh d?u n?i b?t"}>
                    <Button
                        type="text"
                        icon={record.is_featured ? <StarFilled style={{ color: '#faad14' }} /> : <StarOutlined />}
                        onClick={() => toggleFeatured(record)}
                        disabled={!record.is_featured && !['APPROVED', 'PUBLISHED', 'ONGOING'].includes(record.status)}
                    />
                </Tooltip>
            ),
        },
        {
            title: 'THAO TÁC',
            key: 'actions',
            align: 'right',
            render: (_, record) => (
                <Button
                    type={record.status === 'PENDING_APPROVAL' ? "primary" : "default"}
                    size="small"
                    icon={<EyeOutlined />}
                    onClick={() => { setSelectedEvent(record); setShowModal(true); }}
                >
                    {record.status === 'PENDING_APPROVAL' ? 'Duy?t' : 'Chi ti?t'}
                </Button>
            ),
        },
    ];

    // For icons that were missing
    const SyncOutlined = ({ spin }) => <ReloadOutlined spin={spin} />;
    const ClockCircleOutlined = () => <CalendarOutlined />;

    if (loading) {
        return <AdminLoadingScreen tip="Đang t?i danh sách s? ki?n..." />;
    }

    return (
        <div style={{ padding: '0 24px' }}>
            <Card
                title={
                    <Space style={{ width: '100%', justifyContent: 'space-between' }}>
                        <Title level={4} style={{ margin: 0 }}>Qu?n Lư S? Ki?n</Title>
                        <Button
                            icon={<ReloadOutlined />}
                            onClick={() => fetchEvents()}
                            disabled={loading}
                        >
                            Làm m?i
                        </Button>
                    </Space>
                }
                style={{ marginBottom: 24, borderRadius: 12, boxShadow: '0 4px 12px rgba(0,0,0,0.05)' }}
            >
                <Row gutter={16}>
                    <Col xs={24} md={8}>
                        <div style={{ marginBottom: 8, fontSize: 12, color: '#8c8c8c', fontWeight: 600 }}>T̀M KI?M</div>
                        <Input
                            placeholder="Tên s? ki?n, d?a di?m..."
                            prefix={<SearchOutlined style={{ color: '#bfbfbf' }} />}
                            value={searchQuery}
                            onChange={e => setSearchQuery(e.target.value)}
                            allowClear
                            size="large"
                        />
                    </Col>
                    <Col xs={12} md={8}>
                        <div style={{ marginBottom: 8, fontSize: 12, color: '#8c8c8c', fontWeight: 600 }}>TR?NG THÁI</div>
                        <Select
                            value={filterStatus}
                            style={{ width: '100%' }}
                            onChange={setFilterStatus}
                            size="large"
                        >
                            <Option value="ALL">T?t c? tr?ng thái</Option>
                            <Option value="PENDING_APPROVAL">Ch? phê duy?t</Option>
                            <Option value="APPROVED">Đă phê duy?t</Option>
                            <Option value="PUBLISHED">Đă dang bán</Option>
                            <Option value="REJECTED">Đă t? ch?i</Option>
                            <Option value="ONGOING">Đang di?n ra</Option>
                            <Option value="COMPLETED">Đă k?t thúc</Option>
                        </Select>
                    </Col>
                    <Col xs={12} md={8}>
                        <div style={{ marginBottom: 8, fontSize: 12, color: '#8c8c8c', fontWeight: 600 }}>N?I B?T</div>
                        <Select
                            value={filterFeatured}
                            style={{ width: '100%' }}
                            onChange={setFilterFeatured}
                            size="large"
                        >
                            <Option value="ALL">T?t c?</Option>
                            <Option value="FEATURED">S? ki?n n?i b?t</Option>
                            <Option value="NORMAL">S? ki?n thu?ng</Option>
                        </Select>
                    </Col>
                </Row>
            </Card>

            {pendingCount > 0 && (
                <Alert
                    message={
                        <Space>
                            <WarningOutlined />
                            <Text strong>C?n chú ư: Đang có {pendingCount} s? ki?n ch? b?n phê duy?t.</Text>
                        </Space>
                    }
                    type="warning"
                    showIcon={false}
                    style={{ marginBottom: 24, borderRadius: 8, border: 'none', backgroundColor: '#fffbe6' }}
                />
            )}

            <Card styles={{ body: { padding: 0 } }}>
                <Table
                    columns={columns}
                    dataSource={filteredEvents}
                    rowKey="event_id"
                    pagination={{
                        pageSize: 10,
                        showTotal: (total) => `T?ng s? ${total} s? ki?n`
                    }}
                />
            </Card>

            <Modal
                title={<Text strong style={{ fontSize: 18 }}>Chi Ti?t S? Ki?n</Text>}
                open={showModal}
                onCancel={() => setShowModal(false)}
                footer={null}
                width={800}
                style={{ top: 20 }}
                styles={{ body: { padding: 0 } }}
            >
                <Spin spinning={actionLoading} tip="Đang x? lư...">
                    {selectedEvent && (
                        <div>
                            <div style={{ height: 200, position: 'relative', overflow: 'hidden' }}>
                                <div style={{
                                    position: 'absolute',
                                    inset: 0,
                                    backgroundImage: `url(${selectedEvent.banner_image_url || 'https://via.placeholder.com/800x400?text=No+Image'})`,
                                    backgroundSize: 'cover',
                                    backgroundPosition: 'center',
                                    filter: 'blur(10px) brightness(0.7)'
                                }} />
                                <div style={{
                                    position: 'relative',
                                    height: '100%',
                                    display: 'flex',
                                    alignItems: 'center',
                                    padding: '0 32px',
                                    gap: 24
                                }}>
                                    <img
                                        src={selectedEvent.banner_image_url || 'https://via.placeholder.com/200x200?text=No+Image'}
                                        alt={selectedEvent.event_name}
                                        style={{
                                            width: 120,
                                            height: 120,
                                            borderRadius: 8,
                                            objectFit: 'cover',
                                            border: '3px solid white',
                                            boxShadow: '0 4px 12px rgba(0,0,0,0.2)'
                                        }}
                                    />
                                    <div style={{ color: 'white' }}>
                                        <Title level={4} style={{ color: 'white', margin: 0 }}>{selectedEvent.event_name}</Title>
                                        <Space split={<Divider type="vertical" style={{ borderColor: 'rgba(255,255,255,0.3)' }} />}>
                                            <Text style={{ color: 'rgba(255,255,255,0.8)' }}>
                                                <EnvironmentOutlined /> {selectedEvent.venue?.name || selectedEvent.venue_name}
                                            </Text>
                                            <Text style={{ color: 'rgba(255,255,255,0.8)' }}>
                                                <CalendarOutlined /> {new Date(selectedEvent.start_datetime).toLocaleDateString('vi-VN')}
                                            </Text>
                                        </Space>
                                        <div style={{ marginTop: 12 }}>
                                            {getStatusConfig(selectedEvent.status).label}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div style={{ padding: 32 }}>
                                <Row gutter={32}>
                                    <Col span={16}>
                                        <Title level={5}>Mô t?</Title>
                                        <Paragraph type="secondary">
                                            {selectedEvent.description || 'Không có mô t? cho s? ki?n này.'}
                                        </Paragraph>

                                        <Divider />

                                        <Space direction="vertical" size={16} style={{ width: '100%' }}>
                                            <Text strong><AppstoreOutlined /> So d? ch? ng?i</Text>
                                        </Space>
                                        {loadingMap ? (
                                            <div style={{ padding: '40px 0', textAlign: 'center' }}>
                                                <Spin tip="Đang t?i so d?...">
                                                    <div style={{ padding: 20 }} />
                                                </Spin>
                                            </div>
                                        ) : venueTemplate ? (
                                            <Card size="small" style={{ background: '#fafafa' }}>
                                                <div style={{ display: 'flex', justifyContent: 'center', gap: 24, marginBottom: 16, fontSize: 11 }}>
                                                    <Space><Badge color="#f0f0f0" /> <Text type="secondary">Tr?ng</Text></Space>
                                                    <Space><Badge color="#52c41a" /> <Text type="secondary">Đă gán</Text></Space>
                                                    <Space><Badge color="#ff4d4f" /> <Text type="secondary">H?ng khác</Text></Space>
                                                </div>
                                                <SeatMapTemplateView template={venueTemplate} seats={eventSeats} readonly={true} />
                                            </Card>
                                        ) : (
                                            <div style={{ padding: '20px 0', textAlign: 'center', color: '#8c8c8c' }}>
                                                Không có thông tin so d? ch? ng?i
                                            </div>
                                        )}
                                    </Col>

                                    <Col span={8}>
                                        <Title level={5}>Hành d?ng</Title>
                                        <Space direction="vertical" style={{ width: '100%' }}>
                                            {selectedEvent.status === 'PENDING_APPROVAL' && (
                                                <div style={{ display: 'flex', gap: 8 }}>
                                                    <Button
                                                        type="primary"
                                                        block
                                                        icon={<CheckCircleOutlined />}
                                                        onClick={() => handleUpdateStatus(selectedEvent.event_id, 'APPROVED')}
                                                        loading={actionLoading}
                                                    >
                                                        Phê duy?t
                                                    </Button>
                                                    <Button
                                                        danger
                                                        block
                                                        icon={<CloseCircleOutlined />}
                                                        onClick={() => handleUpdateStatus(selectedEvent.event_id, 'REJECTED')}
                                                        loading={actionLoading}
                                                    >
                                                        T? ch?i
                                                    </Button>
                                                </div>
                                            )}

                                            {selectedEvent.status === 'APPROVED' && (
                                                <Button
                                                    type="primary"
                                                    block
                                                    onClick={() => handleUpdateStatus(selectedEvent.event_id, 'PUBLISHED')}
                                                    loading={actionLoading}
                                                >
                                                    Công khai bán vé
                                                </Button>
                                            )}

                                            <Button
                                                block
                                                icon={selectedEvent.is_featured ? <StarFilled style={{ color: '#fadb14' }} /> : <StarOutlined />}
                                                onClick={() => toggleFeatured(selectedEvent)}
                                                loading={actionLoading}
                                            >
                                                {selectedEvent.is_featured ? 'B? n?i b?t' : 'Đ?t làm n?i b?t'}
                                            </Button>

                                            {(selectedEvent.status === 'PENDING_APPROVAL' || selectedEvent.status === 'REJECTED' || selectedEvent.status === 'PENDING_DELETION') && (
                                                <Button
                                                    danger
                                                    block
                                                    icon={<DeleteOutlined />}
                                                    onClick={() => handleDeleteEvent(selectedEvent.event_id)}
                                                    loading={actionLoading}
                                                >
                                                    Xóa vinh vi?n
                                                </Button>
                                            )}
                                        </Space>
                                    </Col>
                                </Row>
                            </div>
                        </div>
                    )}
                </Spin>
            </Modal>
            <style dangerouslySetInnerHTML={{
                __html: `
                .pending-row { background-color: #fffbe6 !important; }
                .pending-row:hover td { background-color: #fff1b8 !important; }
            `}} />
        </div>
    );
};

export default AdminEventsManagement;

import React, { useState, useEffect } from 'react';
import {
    Card,
    Grid,
    Button,
    Typography,
    Space,
    Tag,
    Modal,
    InputNumber,
    Input,
    message,
    Spin,
    Divider,
    Tooltip,
    Row,
    Col,
    Badge,
    List,
    Alert
} from 'antd';
import {
    ReloadOutlined,
    EnvironmentOutlined,
    EditOutlined,
    SaveOutlined,
    CloseOutlined,
    PlusOutlined,
    DeleteOutlined,
    AppstoreOutlined,
    StopOutlined,
    InfoCircleOutlined,
    ToolOutlined
} from '@ant-design/icons';
import { api } from '@services/api';

const { Text, Title } = Typography;

const VenuesManagement = () => {
    const [loading, setLoading] = useState(true);
    const [venues, setVenues] = useState([]);
    const [selectedVenue, setSelectedVenue] = useState(null);
    const [showEditModal, setShowEditModal] = useState(false);
    const [saving, setSaving] = useState(false);
    const [areas, setAreas] = useState([]);
    const [activeAreaIndex, setActiveAreaIndex] = useState(0);
    const [isDragging, setIsDragging] = useState(false);
    const [dragAction, setDragAction] = useState(null); // 'lock' or 'unlock'

    useEffect(() => {
        const handleGlobalMouseUp = () => setIsDragging(false);
        window.addEventListener('mouseup', handleGlobalMouseUp);
        return () => window.removeEventListener('mouseup', handleGlobalMouseUp);
    }, []);

    useEffect(() => {
        fetchVenues();
    }, []);

    const fetchVenues = async () => {
        try {
            setLoading(true);
            const res = await api.getAllVenues();
            if (res.success) setVenues(res.data);
        } catch (error) {
            console.error("Error fetching venues:", error);
            message.error("Lá»—i khi táº£i thĂ´ng tin Ä‘á»‹a Ä‘iá»ƒm");
        } finally {
            setLoading(false);
        }
    };

    const handleEditLayout = (venue) => {
        setSelectedVenue(venue);
        const template = venue.seat_map_template || { areas: [] };
        setAreas(template.areas || []);
        setActiveAreaIndex(0);
        setShowEditModal(true);
    };

    const addNewArea = () => {
        const newArea = {
            name: `Khu vá»±c ${areas.length + 1}`,
            rows: 5,
            cols: 10,
            locked_seats: []
        };
        setAreas([...areas, newArea]);
        setActiveAreaIndex(areas.length);
    };

    const removeArea = (index) => {
        const newAreas = areas.filter((_, i) => i !== index);
        setAreas(newAreas);
        if (activeAreaIndex >= newAreas.length) {
            setActiveAreaIndex(Math.max(0, newAreas.length - 1));
        }
    };

    const updateAreaProperty = (index, prop, value) => {
        const newAreas = [...areas];
        newAreas[index][prop] = value;
        setAreas(newAreas);
    };

    const toggleSeatLock = (areaIndex, row, col) => {
        const seatId = `${row}-${col}`;
        const newAreas = [...areas];
        const area = newAreas[areaIndex];
        if (area.locked_seats.includes(seatId)) {
            area.locked_seats = area.locked_seats.filter(id => id !== seatId);
        } else {
            area.locked_seats.push(seatId);
        }
        setAreas(newAreas);
    };

    const handleSeatMouseDown = (areaIndex, row, col) => {
        setIsDragging(true);
        const seatId = `${row}-${col}`;
        const area = areas[areaIndex];
        const isCurrentlyLocked = area.locked_seats.includes(seatId);
        const action = isCurrentlyLocked ? 'unlock' : 'lock';
        setDragAction(action);
        applySeatAction(areaIndex, row, col, action);
    };

    const handleSeatMouseEnter = (areaIndex, row, col) => {
        if (!isDragging) return;
        applySeatAction(areaIndex, row, col, dragAction);
    };

    const applySeatAction = (areaIndex, row, col, action) => {
        const seatId = `${row}-${col}`;
        const newAreas = [...areas];
        const area = newAreas[areaIndex];

        if (action === 'lock' && !area.locked_seats.includes(seatId)) {
            area.locked_seats = [...area.locked_seats, seatId];
            setAreas(newAreas);
        } else if (action === 'unlock' && area.locked_seats.includes(seatId)) {
            area.locked_seats = area.locked_seats.filter(id => id !== seatId);
            setAreas(newAreas);
        }
    };

    const handleSaveLayout = async () => {
        try {
            setSaving(true);
            const totalCapacity = areas.reduce((sum, area) => sum + (area.rows * area.cols), 0);

            const payload = {
                capacity: totalCapacity,
                seat_map_template: { areas }
            };

            const res = await api.updateVenueSeats(selectedVenue.venue_id, payload);
            if (res.success) {
                message.success("Cáº­p nháº­t sÆ¡ Ä‘á»“ Ä‘á»‹a Ä‘iá»ƒm thĂ nh cĂ´ng!");
                setShowEditModal(false);
                fetchVenues();
            }
        } catch (error) {
            message.error(error.message);
        } finally {
            setSaving(false);
        }
    };

    const handleToggleMaintenance = async (venue) => {
        const newStatus = venue.status === 'MAINTENANCE' ? 'ACTIVE' : 'MAINTENANCE';
        try {
            const res = await api.updateVenueStatus(venue.venue_id, newStatus);
            if (res.success) {
                message.success(`Ä�Ă£ chuyá»ƒn ${venue.venue_name} sang ${newStatus === 'MAINTENANCE' ? 'cháº¿ Ä‘á»™ báº£o trĂ¬' : 'tráº¡ng thĂ¡i hoáº¡t Ä‘á»™ng'}`);
                fetchVenues();
            }
        } catch (error) {
            message.error(error.message);
        }
    };

    const renderSeatMap = (area, areaIndex) => {
        const rows = [];
        for (let r = 1; r <= area.rows; r++) {
            const cols = [];
            for (let c = 1; c <= area.cols; c++) {
                const isLocked = area.locked_seats.includes(`${r}-${c}`);
                cols.push(
                    <Tooltip title={`HĂ ng ${r}, Gháº¿ ${c} ${isLocked ? '(Há»�ng/KhĂ³a)' : ''}`} key={`${r}-${c}`}><div
                        onMouseDown={() => handleSeatMouseDown(areaIndex, r, c)}
                        onMouseEnter={() => handleSeatMouseEnter(areaIndex, r, c)}
                        style={{
                            width: 28,
                            height: 28,
                            margin: 4,
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            borderRadius: 4,
                            cursor: 'pointer',
                            backgroundColor: isLocked ? '#ff4d4f' : '#f0f0f0',
                            color: isLocked ? 'white' : 'rgba(0,0,0,0.45)',
                            fontSize: 10,
                            fontWeight: 'bold',
                            userSelect: 'none',
                            transition: 'all 0.2s',
                            border: isLocked ? 'none' : '1px solid #d9d9d9'
                        }}
                        className="seat-item"
                    >
                        {isLocked ? <StopOutlined style={{ fontSize: 14 }} /> : `${String.fromCharCode(64 + r)}${c}`}
                    </div>
                    </Tooltip>
                );
            }
            rows.push(
                <div key={r} style={{ display: 'flex', justifyContent: 'center' }}>
                    {cols}
                </div>
            );
        }
        return (
            <div style={{
                padding: '24px',
                backgroundColor: '#fafafa',
                borderRadius: 8,
                overflowX: 'auto',
                minHeight: 200,
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                border: '1px solid #f0f0f0'
            }}>
                <div style={{ marginBottom: 32, width: '100%', textAlign: 'center' }}>
                    <div style={{
                        width: '60%',
                        margin: '0 auto',
                        padding: '8px',
                        background: '#e8e8e8',
                        borderRadius: '0 0 20px 20px',
                        fontSize: 12,
                        color: '#8c8c8c',
                        fontWeight: 600
                    }}>
                        SĂ‚N KHáº¤U / MĂ€N HĂŒNH
                    </div>
                </div>
                {rows}
            </div>
        );
    };

    if (loading && venues.length === 0) {
        return (
            <div style={{ display: 'flex', justifyContent: 'center', padding: '100px 0' }}>
                <Spin tip="Ä�ang táº£i dá»¯ liá»‡u...">
                    <div style={{ padding: 50 }} />
                </Spin>
            </div>
        );
    }

    return (
        <Spin spinning={loading || saving} tip="Vui lĂ²ng Ä‘á»£i...">
            <div>
                <Space style={{ marginBottom: 24, width: '100%', justifyContent: 'flex-end' }}>
                    <Button icon={<ReloadOutlined />} onClick={fetchVenues} disabled={loading || saving}>LĂ m má»›i</Button>
                </Space>

                <Row gutter={[24, 24]}>
                    {venues.map((venue) => {
                        const template = venue.seat_map_template || { areas: [] };
                        const areaCount = template.areas?.length || 0;
                        const totalSeats = template.areas?.reduce((sum, a) => sum + (a.rows * a.cols), 0) || 0;
                        const lockedCount = template.areas?.reduce((sum, a) => sum + (a.locked_seats?.length || 0), 0) || 0;

                        return (
                            <Col xs={24} md={12} lg={8} key={venue.venue_id}>
                                <Card
                                    hoverable
                                    actions={[
                                        <Button type="link" icon={<EditOutlined />} onClick={() => handleEditLayout(venue)} disabled={loading || saving}>SÆ¡ Ä‘á»“</Button>,
                                        <Button
                                            type="link"
                                            danger={venue.status !== 'MAINTENANCE'}
                                            icon={<ToolOutlined />}
                                            onClick={() => handleToggleMaintenance(venue)}
                                            disabled={loading || saving}
                                        >
                                            {venue.status === 'MAINTENANCE' ? 'Káº¿t thĂºc báº£o trĂ¬' : 'Báº£o trĂ¬'}
                                        </Button>
                                    ]}
                                >
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 16 }}>
                                        <div>
                                            <Title level={5} style={{ margin: 0 }}>{venue.venue_name}</Title>
                                            <Text type="secondary" style={{ fontSize: 12 }}>
                                                <EnvironmentOutlined /> {venue.city || 'ChÆ°a cáº­p nháº­t'}
                                            </Text>
                                        </div>
                                        <Space size={4}>
                                            {venue.status === 'MAINTENANCE' && <Tag color="warning" icon={<ToolOutlined />}>Báº¢O TRĂŒ</Tag>}
                                            <Tag color={venue.is_active ? 'success' : 'default'}>
                                                {venue.is_active ? 'Sáº´N SĂ€NG' : 'Báº¢N NHĂ�P'}
                                            </Tag>
                                        </Space>
                                    </div>

                                    <Divider style={{ margin: '12px 0' }} />

                                    <Row gutter={16}>
                                        <Col span={8}>
                                            <Text type="secondary" style={{ fontSize: 11 }}>KHU Vá»°C</Text><br />
                                            <Text strong>{areaCount}</Text>
                                        </Col>
                                        <Col span={8}>
                                            <Text type="secondary" style={{ fontSize: 11 }}>Tá»”NG GHáº¾</Text><br />
                                            <Text strong>{totalSeats}</Text>
                                        </Col>
                                        <Col span={8}>
                                            <Text type="secondary" style={{ fontSize: 11 }}>GHáº¾ Há»�NG</Text><br />
                                            <Text strong style={{ color: lockedCount > 0 ? '#ff4d4f' : 'inherit' }}>{lockedCount}</Text>
                                        </Col>
                                    </Row>
                                </Card>
                            </Col>
                        );
                    })}
                </Row>

                <Modal
                    title={`Thiáº¿t Káº¿ SÆ¡ Ä�á»“: ${selectedVenue?.venue_name}`}
                    open={showEditModal}
                    onCancel={() => !saving && setShowEditModal(false)}
                    width={1100}
                    style={{ top: 20 }}
                    footer={[
                        <Button key="cancel" onClick={() => setShowEditModal(false)} disabled={saving}>Há»§y bá»�</Button>,
                        <Button key="save" type="primary" icon={<SaveOutlined />} onClick={handleSaveLayout} loading={saving} disabled={areas.length === 0}>
                            LÆ°u sÆ¡ Ä‘á»“ Ä‘á»‹a Ä‘iá»ƒm
                        </Button>
                    ]}
                    styles={{ body: { padding: 0 } }}
                >
                    <div style={{ display: 'flex', height: '70vh' }}>
                        {/* Sidebar */}
                        <div style={{ width: 280, borderRight: '1px solid #f0f0f0', padding: 24, backgroundColor: '#fafafa', overflowY: 'auto' }}>
                            <Button
                                block
                                type="dashed"
                                icon={<PlusOutlined />}
                                onClick={addNewArea}
                                style={{ marginBottom: 24 }}
                                disabled={saving}
                            >
                                ThĂªm khu vá»±c má»›i
                            </Button>

                            <Text strong style={{ fontSize: 11, color: '#8c8c8c', textTransform: 'uppercase' }}>
                                Danh sĂ¡ch khu vá»±c ({areas.length})
                            </Text>

                            <div style={{ marginTop: 16 }}>
                                {areas.map((area, idx) => (
                                    <div
                                        key={idx}
                                        onClick={() => !saving && setActiveAreaIndex(idx)}
                                        style={{
                                            padding: '12px 16px',
                                            marginBottom: 8,
                                            borderRadius: 8,
                                            border: '1px solid',
                                            borderColor: activeAreaIndex === idx ? '#52c41a' : '#f0f0f0',
                                            backgroundColor: activeAreaIndex === idx ? '#f6ffed' : 'white',
                                            cursor: saving ? 'not-allowed' : 'pointer',
                                            position: 'relative',
                                            transition: 'all 0.3s'
                                        }}
                                    >
                                        <Text strong style={{ color: activeAreaIndex === idx ? '#52c41a' : 'inherit' }}>{area.name}</Text><br />
                                        <Text type="secondary" style={{ fontSize: 11 }}>{area.rows} x {area.cols} ({area.rows * area.cols} gháº¿)</Text>
                                        <Button
                                            type="text"
                                            size="small"
                                            danger
                                            icon={<DeleteOutlined />}
                                            style={{ position: 'absolute', top: 12, right: 8 }}
                                            onClick={(e) => { e.stopPropagation(); !saving && removeArea(idx); }}
                                            disabled={saving}
                                        />
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Editor */}
                        <div style={{ flex: 1, padding: 32, overflowY: 'auto' }}>
                            {areas.length > 0 ? (
                                <div>
                                    <Row gutter={24} style={{ marginBottom: 32 }}>
                                        <Col span={10}>
                                            <Text type="secondary" style={{ fontSize: 12 }}>TĂ�N KHU Vá»°C</Text>
                                            <Input
                                                value={areas[activeAreaIndex].name}
                                                onChange={e => updateAreaProperty(activeAreaIndex, 'name', e.target.value)}
                                                disabled={saving}
                                            />
                                        </Col>
                                        <Col span={4}>
                                            <Text type="secondary" style={{ fontSize: 12 }}>Sá»� HĂ€NG</Text><br />
                                            <InputNumber
                                                min={1} max={50}
                                                value={areas[activeAreaIndex].rows}
                                                onChange={val => updateAreaProperty(activeAreaIndex, 'rows', val || 1)}
                                                style={{ width: '100%' }}
                                                disabled={saving}
                                            />
                                        </Col>
                                        <Col span={4}>
                                            <Text type="secondary" style={{ fontSize: 12 }}>Sá»� Cá»˜T</Text><br />
                                            <InputNumber
                                                min={1} max={50}
                                                value={areas[activeAreaIndex].cols}
                                                onChange={val => updateAreaProperty(activeAreaIndex, 'cols', val || 1)}
                                                style={{ width: '100%' }}
                                                disabled={saving}
                                            />
                                        </Col>
                                        <Col span={6} style={{ display: 'flex', alignItems: 'flex-end' }}>
                                            <Tag color="error" icon={<StopOutlined />}>
                                                {areas[activeAreaIndex].locked_seats.length} gháº¿ há»�ng
                                            </Tag>
                                        </Col>
                                    </Row>

                                    <Title level={5}>TrĂ¬nh xem trÆ°á»›c sÆ¡ Ä‘á»“</Title>
                                    {renderSeatMap(areas[activeAreaIndex], activeAreaIndex)}
                                </div>
                            ) : (
                                <div style={{ height: '100%', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', opacity: 0.5 }}>
                                    <AppstoreOutlined style={{ fontSize: 64, marginBottom: 16 }} />
                                    <Text>ThĂªm khu vá»±c Ä‘á»ƒ báº¯t Ä‘áº§u thiáº¿t káº¿ sÆ¡ Ä‘á»“</Text>
                                </div>
                            )}
                        </div>
                    </div>
                </Modal>
                <style dangerouslySetInnerHTML={{
                    __html: `
                    .seat-item:hover {
                        box-shadow: 0 0 8px rgba(82, 196, 26, 0.4);
                        border-color: #52c41a !important;
                    }
                `}} />
            </div>
        </Spin>
    );
};

export default VenuesManagement;
